name: AI Test Coverage Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  ai_review:
    # Your Colab runner registers with these labels
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install -U pip
          [ -f requirements.txt ] && pip install -r requirements.txt || true
          [ -f src/requirements.txt ] && pip install -r src/requirements.txt || true
          pip install pytest requests

      # Safety checks before generation
      - name: Verify repo layout
        shell: bash
        run: |
          test -f app.py || { echo "❌ app.py is missing at repo root"; exit 1; }
          test -f src/github_test_coverage.py || { echo "❌ src/github_test_coverage.py is missing"; exit 1; }
          echo "✅ Found app.py and generator script"

      - name: Verify Ollama is running (Colab)
        shell: bash
        run: |
          curl -sf http://127.0.0.1:11434/api/tags >/dev/null || {
            echo "❌ Ollama not reachable at http://127.0.0.1:11434";
            echo "Start it in Colab:  ollama serve  &   and pull model:  ollama pull mistral:7b";
            exit 1;
          }
          echo "✅ Ollama is reachable"

      - name: Generate tests with Ollama
        shell: bash
        env:
          # Generator configuration
          SRC_PATH: app.py
          TEST_PATH: tests/test_app_generated.py
          LLM_URL: http://127.0.0.1:11434/api/generate
          LLM_MODEL: mistral:7b
        run: |
          echo "PWD: $(pwd)"
          python src/github_test_coverage.py

      - name: Debug: show generated file
        shell: bash
        run: |
          echo "==== repo tree (depth 3) ===="
          find . -maxdepth 3 -type f | sort
          test -f tests/test_app_generated.py || { echo "❌ tests/test_app_generated.py not found"; exit 1; }
          echo "==== tests/test_app_generated.py (head) ===="
          sed -n '1,120p' tests/test_app_generated.py

      - name: Run Pytest
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest -q tests/

      - name: Upload generated tests (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-generated-tests
          path: tests/test_app_generated.py
