name: AI Test Coverage Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  ai_review:
    # Your Colab runner registers with these labels
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install -U pip
          [ -f requirements.txt ] && pip install -r requirements.txt || true
          pip install pytest requests

      # Health check to ensure Ollama in Colab is reachable
      - name: Verify Ollama is running
        shell: bash
        run: |
          curl -sf http://127.0.0.1:11434/api/tags >/dev/null || {
            echo "❌ Ollama is not reachable at http://127.0.0.1:11434";
            echo "Start it in Colab with:  ollama serve  (and pull model: ollama pull mistral:7b)";
            exit 1;
          }

      - name: Generate tests with Ollama (mistral:7b)
        shell: bash
        env:
          BOT: ollama
          LLM_URL: http://127.0.0.1:11434/api/generate   # <- matches your script
          LLM_MODEL: mistral:7b                           # <- your model
          SRC_PATH: app.py
          TEST_PATH: tests/test_app_generated.py
        run: |
          echo "PWD: $(pwd)"
          ls -la
          python src_github_test_coverage.py

      - name: Debug: show generated file
        shell: bash
        run: |
          echo "==== repo tree (depth 3) ===="
          find . -maxdepth 3 -type f | sort
          test -f tests/test_app_generated.py || { echo "❌ tests/test_app_generated.py not found"; exit 1; }
          echo "==== tests/test_app_generated.py (head) ===="
          sed -n '1,120p' tests/test_app_generated.py

      - name: Run Pytest
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest -q tests/

      - name: Upload generated tests (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-generated-tests
          path: tests/test_app_generated.py
